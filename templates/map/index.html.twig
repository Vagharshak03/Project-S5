<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Forest / Deforested Polygons</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ asset('assets/css/index.css') }}">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        #map { width: 100%; height: 85vh; }
        #panel {
            position: absolute; top: 10px; left: 450px; z-index: 5;
            background: rgba(255,255,255,0.95); padding: 8px; border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #panel input { margin-right: 5px; }
    </style>
</head>
<body>
<div id="panel">
    <div>
        City: <input id="city" placeholder="Yerevan">
        <button id="searchCityBtn">Search</button>
        Radius (m): <input id="radius" value="50000">
    </div>
    <div style="margin-top:4px;">Click anywhere on the map to explore forest cover</div>
    <div id="status" style="margin-top:6px;font-size:13px;color:#333"></div>
</div>

<div id="map"></div>

<script src="{{ asset('assets/js/index.js') }}"></script>
<script>
    // Global variable to store current context analysis for the probability step
    let currentAnalysisContext = {};

    window.initMap = function() {
        const map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 40.1772, lng: 44.5035 }, // Default: Armenia
            zoom: 8,
            mapTypeId: 'satellite',
            mapTypeControl: true,
            mapTypeControlOptions: {
                style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                position: google.maps.ControlPosition.TOP_RIGHT,
                mapTypeIds: ['roadmap','satellite','hybrid','terrain']
            },
            zoomControl: true,
            streetViewControl: false,
            fullscreenControl: true
        });

        const infoWindow = new google.maps.InfoWindow();
        const statusEl = document.getElementById('status');

        function setStatus(text) { statusEl.innerText = text; }

        // 1. General Map Click (Loads polygons around click)
        map.addListener('click', event => {
            const lat = event.latLng.lat();
            const lng = event.latLng.lng();
            setStatus(`Clicked location: ${lat.toFixed(5)}, ${lng.toFixed(5)}`);
            loadPolygons(map, infoWindow, lat, lng);
        });

        // 2. City Search Logic
        document.getElementById('searchCityBtn').addEventListener('click', async () => {
            const city = document.getElementById('city').value.trim();
            if (!city) { setStatus('Please enter a city name'); return; }

            setStatus(`Searching for city: ${city}...`);
            try {
                const geoResp = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(city)}&format=json&limit=1`, {
                    headers: { 'User-Agent': 'SymfonyApp/1.0' }
                });
                const geoData = await geoResp.json();
                if (!geoData || geoData.length === 0) { setStatus('City not found'); return; }

                const lat = parseFloat(geoData[0].lat);
                const lng = parseFloat(geoData[0].lon);
                map.setCenter({ lat, lng });
                map.setZoom(10);
                setStatus(`City found: ${city} (${lat.toFixed(5)}, ${lng.toFixed(5)})`);
                loadPolygons(map, infoWindow, lat, lng);
            } catch(err) {
                setStatus('Failed to search city: ' + err.message);
            }
        });

        // =========================================================
        // MAIN WORKFLOW: POLYGON CLICK -> ANALYZE -> SUGGEST
        // =========================================================

        map.data.addListener('click', async (event) => {

            // A. Get Center of the clicked polygon
            const center = getFeatureCenter(event.feature, map);
            const latC = center.lat;
            const lngC = center.lng;

            // B. Initial "Loading" InfoWindow
            infoWindow.setPosition(center);
            infoWindow.setContent(`
                <div style="padding:15px; font-family: sans-serif; text-align:center;">
                    <div style="margin-bottom:5px; font-weight:bold; color:#555;">Scanning Area Physics...</div>
                    <div class="loader" style="margin:0 auto; border:3px solid #f3f3f3; border-radius:50%; border-top:3px solid #3498db; width:25px; height:25px; -webkit-animation:spin 1s linear infinite; animation:spin 1s linear infinite;"></div>
                </div>
            `);
            infoWindow.open(map);

            // C. STEP 1: Fetch PHYSICS (Agromonitoring via your Backend)
            try {
                // Call your Symfony AnalysisController
                const apiResp = await fetch(`/api/analyze-area?lat=${latC}&lng=${lngC}`);
                const apiJson = await apiResp.json();

                if(apiJson.error) throw new Error(apiJson.error);

                const physics = apiJson.climate;
                const meta = apiJson.calculated_conditions;

                // Save for Step 3 calculation later
                currentAnalysisContext = {
                    humidity: physics.humidity,
                    temp: physics.temp
                };

                // D. Build the Content HTML (Physics + Button for Biology)
                const finalHtml = `
                    <div style="font-family: 'Segoe UI', Arial, sans-serif; font-size:13px; width:280px;">
                        <h3 style="margin:0 0 8px 0; border-bottom:2px solid #2c3e50; padding-bottom:5px; color:#2c3e50;">
                            Environmental Profile
                        </h3>

                        <!-- PHYSICS CARD -->
                        <div style="background:#e8f6f3; padding:8px; border-radius:5px; border-left:4px solid #1abc9c; margin-bottom:8px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span>üå°Ô∏è Temp: <b>${physics.temp}¬∞C</b></span>
                                <span>üíß Hum: <b>${physics.humidity}%</b></span>
                            </div>
                            <div style="color:#555; font-size:11px;">
                                Weather: ${physics.description}<br>
                                <i>Zone Type: ${meta.bioclimatic_type}</i>
                            </div>
                        </div>

                        <!-- BUTTON FOR STEP 2 -->
                        <button onclick="window.fetchTreeSuggestions(${latC}, ${lngC})"
                            style="width:100%; background:#27ae60; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer; font-weight:600; font-size:12px; transition: background 0.3s;">
                            üå± Find Compatible Trees
                        </button>

                        <!-- RESULTS CONTAINER (Empty initially) -->
                        <div id="tree-results-container" style="min-height:10px; margin-top:10px;"></div>

                        <details style="margin-top:10px; color:#95a5a6; border-top:1px solid #eee; padding-top:5px;">
                            <summary style="font-size:10px; cursor:pointer;">Raw Polygon Properties</summary>
                            <div style="font-size:10px; max-height:80px; overflow-y:auto; color:#333;">
                                ${JSON.stringify(event.feature.getProperty('attributes') || event.feature.getProperty('properties'), null, 2)}
                            </div>
                        </details>
                    </div>
                `;

                infoWindow.setContent(finalHtml);

            } catch(e) {
                console.error(e);
                infoWindow.setContent(`
                    <div style="color:#e74c3c; padding:10px;">
                        <b>Analysis Error:</b><br>${e.message}<br>
                        <small>Check if /api/analyze-area is working.</small>
                    </div>
                `);
            }
        });
    };

    // =========================================================
    // STEP 2 FUNCTION: BIOLOGY SUGGESTIONS
    // Defined on 'window' so the HTML onclick="" can find it
    // =========================================================
    window.fetchTreeSuggestions = async function(lat, lng) {
        const container = document.getElementById('tree-results-container');
        if(!container) return;

        // UI Loading State
        container.innerHTML = `
            <div style="text-align:center; margin-top:10px;">
                <span style="font-size:11px; color:#7f8c8d;">Querying Perenual Biology Database...</span>
                <div class="loader" style="margin:5px auto; border:2px solid #eee; border-top:2px solid #27ae60; border-radius:50%; width:16px; height:16px; -webkit-animation:spin 0.8s linear infinite; animation:spin 0.8s linear infinite;"></div>
            </div>
        `;

        try {
            // Call Symfony RecommendationController
            const response = await fetch(`/api/suggest-trees?lat=${lat}`);
            const data = await response.json();

            if(data.error) throw new Error(data.error);

            // Render List
            let html = `<div style="background:#fff; border:1px solid #eee; border-radius:4px; padding:5px;">`;
            html += `<div style="font-size:11px; color:#2c3e50; font-weight:bold; margin-bottom:5px;">Hardiness Zone ${data.zone_detected} Results:</div>`;
            html += `<ul style="list-style:none; padding:0; margin:0;">`;

            data.suggestions.forEach(tree => {
                const img = tree.image ?
                    `<img src="${tree.image}" style="width:28px; height:28px; border-radius:50%; object-fit:cover; margin-right:8px;">` :
                    `<span style="font-size:18px; margin-right:5px;">üå≥</span>`;

                // Safe handling of names for the function parameters
                const safeName = tree.name.replace(/'/g, "\\'");
                const safeWater = tree.watering ? tree.watering.replace(/'/g, "\\'") : 'Average';

                html += `
                    <li style="border-bottom:1px solid #f9f9f9; padding:6px 0; display:flex; align-items:center; cursor:pointer; transition:background 0.2s;"
                        onmouseover="this.style.background='#fcfcfc'" onmouseout="this.style.background='transparent'"
                        onclick="window.calculateProbability('${safeName}', '${safeWater}')">

                        ${img}

                        <div style="flex-grow:1;">
                            <div style="font-weight:600; font-size:12px; color:#2c3e50;">${tree.name}</div>
                            <div style="font-size:10px; color:#7f8c8d;">
                                Sun: ${tree.sunlight} | üíß: ${tree.watering}
                            </div>
                        </div>
                        <div style="color:#2980b9; font-size:10px;">Select &rarr;</div>
                    </li>
                `;
            });

            html += `</ul></div>`;
            container.innerHTML = html;

        } catch(e) {
            container.innerHTML = `<div style="color:#c0392b; font-size:11px;">‚ö†Ô∏è Failed to load trees: ${e.message}</div>`;
        }
    };

    // =========================================================
    // STEP 3: PROBABILITY CALCULATION (Client Side Logic)
    // =========================================================
    window.calculateProbability = function(treeName, wateringNeeds) {
        // Logic: Compare "Biology Needs" (wateringNeeds) vs "Environment Reality" (currentAnalysisContext)

        // 1. Convert water needs string to a generic 0-100 scale estimate
        // frequent/high -> needs ~80% moisture
        // average -> needs ~50%
        // minimum -> needs ~30%
        let neededHum = 50;
        if(String(wateringNeeds).toLowerCase().includes('frequent')) neededHum = 75;
        if(String(wateringNeeds).toLowerCase().includes('min')) neededHum = 25;

        // 2. Compare with actual Humidity
        const actualHum = currentAnalysisContext.humidity || 50;

        // 3. Simple Algorithm for Success %
        let score = 100 - Math.abs(actualHum - neededHum);
        // Penalize extreme temp mismatch
        if(currentAnalysisContext.temp > 35) score -= 15; // Too hot
        if(score > 98) score = 98; // Realistic max

        let color = '#f39c12'; // Orange
        if(score > 75) color = '#27ae60'; // Green
        if(score < 50) color = '#c0392b'; // Red

        alert(`üå± ANALYSIS REPORT\n\nTarget Tree: ${treeName}\nRequired Water: ${wateringNeeds}\nCurrent Area Humidity: ${actualHum}%\n\nEstimated Growth Success: ${score}%\n\n(Logic: Based on water/humidity match in detected zone)`);
    };

    // =========================================================
    // UTILS
    // =========================================================

    // Existing loader function
    async function loadPolygons(map, infoWindow, lat, lng) {
        const radius = parseInt(document.getElementById('radius').value, 10) || 50000;
        const url = `/api/forest-cover?lat=${lat}&lng=${lng}&radius=${radius}`;
        document.getElementById('status').innerText = 'Fetching polygons...';

        try {
            const res = await fetch(url);
            if (!res.ok) {
                const err = await res.json().catch(()=>({error:'unknown'}));
                document.getElementById('status').innerText = 'Server error: ' + (err.error || res.statusText);
                return;
            }

            const geojson = await res.json();

            // Clear old data
            map.data.forEach(f => map.data.remove(f));

            if (!geojson || !geojson.features || geojson.features.length === 0) {
                document.getElementById('status').innerText = 'No polygons found in this area.';
                return;
            }

            map.data.addGeoJson(geojson);

            // Styler
            map.data.setStyle(feature => {
                const props = feature.getProperty('attributes') || feature.getProperty('properties') || {};
                let fillColor = '#FF6B6B';
                let strokeColor = '#A12';

                // Look for "Forest" keywords to color green
                const rawProps = JSON.stringify(props).toLowerCase();
                if (/forest|tree|wood/.test(rawProps)) {
                    fillColor = '#33A02C';
                    strokeColor = '#166A13';
                }

                return { fillColor, strokeColor, strokeWeight: 1, fillOpacity: 0.5 };
            });

            document.getElementById('status').innerText = `Loaded ${geojson.features.length} features.`;
        } catch(err) {
            document.getElementById('status').innerText = 'Error loading data: ' + err.message;
        }
    }

    function getFeatureCenter(feature, map) {
        const geo = feature.getGeometry();
        if(!geo) return map.getCenter();

        if (geo.getType() === 'Polygon') {
            const path = geo.getArray()[0];
            let latSum = 0, lngSum = 0;
            const len = path.getLength();
            for(let i=0; i<len; i++) {
                latSum += path.getAt(i).lat();
                lngSum += path.getAt(i).lng();
            }
            return {lat: latSum/len, lng: lngSum/len};
        } else if (geo.getType() === 'MultiPolygon') {
            const path = geo.getArray()[0].getArray()[0]; // First poly, outer ring
            const p = path.getAt(0);
            return {lat: p.lat(), lng: p.lng()};
        }
        return map.getCenter();
    }
</script>

<!-- STYLE FOR SPINNER -->
<style>
    /* Required for the simple loader */
    @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>


<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ apiKey }}&callback=initMap"></script>
</body>
</html>
